<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Chat Application</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
  <style>
    /* Global Styles */
    body { font-family: 'Montserrat', sans-serif; margin: 0; padding: 0; background: #f0f2f5; }
    
    /* Login/Register Container */
    #authContainer {
      max-width: 400px; margin: 100px auto; background: #fff; padding: 30px; border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h2 { text-align: center; margin-bottom: 20px; }
    form { display: flex; flex-direction: column; }
    input { padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px; }
    button { padding: 10px; background: #4285f4; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
    .toggle-link { text-align: center; margin-top: 10px; color: #4285f4; cursor: pointer; }
    
    /* Main Application Layout */
    #mainContainer { display: none; height: 100vh; flex-direction: column; }
    #header {
      background: #4285f4; color: #fff; padding: 15px; display: flex; justify-content: space-between; align-items: center;
    }
    #header h1 { margin: 0; font-size: 1.5em; }
    #logoutBtn {
      background: #d9534f; border: none; color: #fff; padding: 5px 10px; border-radius: 4px; cursor: pointer;
    }
    #mainContent {
      display: flex; flex: 1; overflow: hidden;
    }
    
    /* Sidebar (Chat List) */
    #sidebar {
      width: 250px; background: #fff; border-right: 1px solid #ddd; overflow-y: auto;
      display: flex; flex-direction: column;
    }
    #newChatBtn {
      padding: 10px; background: #4285f4; color: #fff; border: none; cursor: pointer;
    }
    #chatList {
      list-style: none; margin: 0; padding: 0; flex: 1;
    }
    #chatList li {
      padding: 10px; border-bottom: 1px solid #ddd; cursor: pointer;
    }
    #chatList li.active { background: #f0f0f0; }
    
    /* Chat Area */
    #chatArea { flex: 1; display: flex; flex-direction: column; }
    #chatControls {
      padding: 10px; border-bottom: 1px solid #ddd; background: #fff; display: flex; justify-content: space-between;
      align-items: center;
    }
    #chatTitle { font-weight: bold; }
    #deleteChatBtn {
      background: #d9534f; border: none; color: #fff; padding: 5px 10px; border-radius: 4px; cursor: pointer;
    }
    #conversation { flex: 1; padding: 15px; overflow-y: auto; background: #f9f9f9; }
    .message { margin-bottom: 10px; }
    .message.user { text-align: right; }
    .message.assistant { text-align: left; }
    .message .text {
      display: inline-block; padding: 10px; border-radius: 8px; max-width: 70%;
    }
    .message.user .text { background: #4285f4; color: #fff; }
    .message.assistant .text { background: #eee; color: #333; }
    #inputArea {
      padding: 10px; border-top: 1px solid #ddd; background: #fff; display: flex;
    }
    #userMessage {
      flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px;
    }
    #sendBtn {
      padding: 10px 20px; margin-left: 10px; background: #4285f4; color: #fff; border: none; border-radius: 4px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- Authentication (Login/Register) Container -->
  <div id="authContainer">
    <div id="loginForm">
      <h2>Login</h2>
      <form onsubmit="return login(event)">
        <input type="text" id="loginUsername" placeholder="Username" required />
        <input type="password" id="loginPassword" placeholder="Password" required />
        <button type="submit">Login</button>
      </form>
      <div class="toggle-link" onclick="showRegister()">Don't have an account? Register</div>
    </div>
    <div id="registerForm" style="display: none;">
      <h2>Register</h2>
      <form onsubmit="return register(event)">
        <input type="text" id="registerUsername" placeholder="Username" required />
        <input type="password" id="registerPassword" placeholder="Password" required />
        <input type="password" id="registerPasswordConfirm" placeholder="Confirm Password" required />
        <button type="submit">Register</button>
      </form>
      <div class="toggle-link" onclick="showLogin()">Already have an account? Login</div>
    </div>
  </div>
  
  <!-- Main Application -->
  <div id="mainContainer">
    <div id="header">
      <h1 id="welcomeMsg"></h1>
      <button id="logoutBtn" onclick="logout()">Logout</button>
    </div>
    <div id="mainContent">
      <!-- Sidebar: Chat List -->
      <div id="sidebar">
        <button id="newChatBtn" onclick="newChat()">New Chat</button>
        <ul id="chatList"></ul>
      </div>
      <!-- Chat Area -->
      <div id="chatArea">
        <div id="chatControls">
          <span id="chatTitle">New Chat</span>
          <button id="deleteChatBtn" onclick="deleteCurrentChat()">Delete Chat</button>
        </div>
        <div id="conversation"></div>
        <div id="inputArea">
          <input type="text" id="userMessage" placeholder="Type your message..." />
          <button id="sendBtn" onclick="sendMessage()">Send</button>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // Gemini API configuration using the provided API key and best model endpoint
    const apiKey = "AIzaSyBExqECRKhZKt5oec5TOVqrlLG9iDOx6Tk";
    const modelEndpoint = "https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=" + apiKey;
    
    let currentUser = null;
    let chats = []; // Array of chat objects: { id, title, conversation: [ {role, text} ] }
    let currentChatId = null;
    
    // Show registration form
    function showRegister() {
      document.getElementById("loginForm").style.display = "none";
      document.getElementById("registerForm").style.display = "block";
    }
    
    // Show login form
    function showLogin() {
      document.getElementById("registerForm").style.display = "none";
      document.getElementById("loginForm").style.display = "block";
    }
    
    // Register new user
    function register(e) {
      e.preventDefault();
      const username = document.getElementById("registerUsername").value.trim();
      const password = document.getElementById("registerPassword").value;
      const passwordConfirm = document.getElementById("registerPasswordConfirm").value;
      if (password !== passwordConfirm) {
        alert("Passwords do not match.");
        return false;
      }
      let users = JSON.parse(localStorage.getItem("users") || "{}");
      if (users[username]) {
        alert("Username already exists.");
        return false;
      }
      users[username] = { password: password };
      localStorage.setItem("users", JSON.stringify(users));
      alert("Registration successful. Please log in.");
      showLogin();
      return false;
    }
    
    // Login function: check credentials from stored users
    function login(e) {
      e.preventDefault();
      const username = document.getElementById("loginUsername").value.trim();
      const password = document.getElementById("loginPassword").value;
      let users = JSON.parse(localStorage.getItem("users") || "{}");
      if (!users[username] || users[username].password !== password) {
        alert("Invalid username or password.");
        return false;
      }
      currentUser = username;
      sessionStorage.setItem("currentUser", currentUser);
      document.getElementById("welcomeMsg").textContent = "Welcome, " + currentUser;
      loadChats();
      document.getElementById("authContainer").style.display = "none";
      document.getElementById("mainContainer").style.display = "flex";
      return false;
    }
    
    function logout() {
      sessionStorage.removeItem("currentUser");
      location.reload();
    }
    
    // Load chats for the current user from localStorage
    function loadChats() {
      const stored = localStorage.getItem("chatHistory_" + currentUser);
      if (stored) {
        chats = JSON.parse(stored);
      } else {
        chats = [];
      }
      // If no chats exist, start a new one.
      if (chats.length === 0) {
        newChat();
      } else {
        currentChatId = chats[0].id;
      }
      renderChatList();
      renderConversation();
    }
    
    // Save chats to localStorage for the current user
    function saveChats() {
      localStorage.setItem("chatHistory_" + currentUser, JSON.stringify(chats));
    }
    
    // Create a new chat and set it as the current chat
    function newChat() {
      const chat = { id: Date.now(), title: "New Chat", conversation: [] };
      chats.unshift(chat);
      currentChatId = chat.id;
      saveChats();
      renderChatList();
      renderConversation();
    }
    
    // Render the chat list in the sidebar
    function renderChatList() {
      const chatListEl = document.getElementById("chatList");
      chatListEl.innerHTML = "";
      chats.forEach(chat => {
        const li = document.createElement("li");
        li.textContent = chat.title;
        li.onclick = () => { currentChatId = chat.id; renderChatList(); renderConversation(); };
        if (chat.id === currentChatId) {
          li.classList.add("active");
        }
        chatListEl.appendChild(li);
      });
    }
    
    // Render the current conversation in the chat area
    function renderConversation() {
      const conversationEl = document.getElementById("conversation");
      conversationEl.innerHTML = "";
      const chat = chats.find(c => c.id === currentChatId);
      if (chat) {
        document.getElementById("chatTitle").textContent = chat.title;
        chat.conversation.forEach(msg => {
          const msgDiv = document.createElement("div");
          msgDiv.className = "message " + msg.role;
          const span = document.createElement("span");
          span.className = "text";
          span.textContent = msg.text;
          msgDiv.appendChild(span);
          conversationEl.appendChild(msgDiv);
        });
        conversationEl.scrollTop = conversationEl.scrollHeight;
      }
    }
    
    // Send a message and get an AI reply via the Gemini API
    async function sendMessage() {
      const input = document.getElementById("userMessage");
      const text = input.value.trim();
      if (!text) return;
      addMessageToCurrentChat("user", text);
      input.value = "";
      
      // Build the prompt using the current conversation
      const chat = chats.find(c => c.id === currentChatId);
      let prompt = "This is a conversation between a user and an AI assistant.\n";
      chat.conversation.forEach(msg => {
        prompt += (msg.role === "user" ? "User: " : "Assistant: ") + msg.text + "\n";
      });
      prompt += "Assistant:";
      
      try {
        const response = await fetch(modelEndpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            contents: [{
              parts: [{ text: prompt }]
            }]
          })
        });
        const data = await response.json();
        const reply = data.candidates[0].content.parts[0].text.trim();
        addMessageToCurrentChat("assistant", reply);
      } catch (error) {
        console.error("Error generating response:", error);
        addMessageToCurrentChat("assistant", "Sorry, an error occurred.");
      }
    }
    
    // Add a message to the current chat and update storage and UI
    function addMessageToCurrentChat(role, text) {
      const chat = chats.find(c => c.id === currentChatId);
      if (chat) {
        chat.conversation.push({ role, text });
        // If it's a new chat, update its title based on the first user message
        if (chat.title === "New Chat" && role === "user") {
          chat.title = text.substring(0, 20) + (text.length > 20 ? "..." : "");
        }
        saveChats();
        renderConversation();
        renderChatList();
      }
    }
    
    // Delete the currently selected chat with confirmation
    function deleteCurrentChat() {
      if (confirm("Are you sure you want to delete this chat?")) {
        chats = chats.filter(c => c.id !== currentChatId);
        saveChats();
        if (chats.length > 0) {
          currentChatId = chats[0].id;
        } else {
          newChat();
        }
        renderChatList();
        renderConversation();
      }
    }
    
    // Allow pressing Enter to send a message
    document.getElementById("userMessage").addEventListener("keydown", function(e) {
      if (e.key === "Enter") sendMessage();
    });
  </script>
</body>
</html>
