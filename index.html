<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Photo Caption Generator</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Playfair+Display:wght@400;700&family=Comic+Neue:wght@700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Montserrat', sans-serif; margin: 0; padding: 20px; background: #f0f2f5; }
    .hidden { display: none !important; }
    
    /* Login Styles */
    #loginContainer {
      max-width: 400px; margin: 100px auto; background: white;
      padding: 2rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      text-align: center;
    }
    #loginContainer h2 { margin-bottom: 1rem; }
    .login-form input { width: 100%; margin-bottom: 1rem; padding: 0.8rem; }
    .login-form button { width: 100%; padding: 1rem; background: #4285f4; color: white; border: none; cursor: pointer; }
    
    /* Main App Styles */
    #appContainer { max-width: 1200px; margin: 0 auto; }
    header { text-align: center; margin-bottom: 2rem; }
    header h1 { font-family: 'Playfair Display', serif; font-size: 2.5em; margin: 0.5rem 0; }
    header p { font-size: 1.2em; color: #555; }
    
    .toolbar { display: flex; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap; justify-content: center; }
    .toolbar input, .toolbar select, .toolbar button, .toolbar input[type="color"] {
      padding: 0.6rem; font-size: 1em;
    }
    .preview-container { position: relative; max-width: 600px; margin: 2rem auto; border: 2px solid #ddd; }
    #imageCanvas { max-width: 100%; display: block; }
    #captionOverlay {
      position: absolute;
      padding: 10px;
      background-color: rgba(0, 0, 0, 0.5);
      color: white;
      border-radius: 5px;
      font-size: 1.2em;
      cursor: move;
      resize: both;
      overflow: visible;
      white-space: pre-wrap;
      word-wrap: break-word;
      max-width: 90%;
      text-align: center;
    }
    #captionOverlay.editing { border: 2px dashed #fff; }
    
    .history-section { margin-top: 3rem; }
    .history-section h3 { text-align: center; }
    .photo-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; }
    .photo-item { position: relative; border: 1px solid #ddd; padding: 5px; border-radius: 5px; background: white; }
    .photo-item img { width: 100%; height: 150px; object-fit: cover; border-radius: 5px; }
    .delete-btn { position: absolute; top: 5px; right: 5px; background: red; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
    .clear-history { margin-top: 1rem; display: block; padding: 0.5rem 1rem; background: #d9534f; color: white; border: none; border-radius: 5px; cursor: pointer; }
    
    /* Edit/Save button styles */
    #editIcon, #saveButton {
      position: absolute;
      top: 10px;
      right: 10px;
      background: blue;
      color: white;
      border: none;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 10;
    }
    #saveButton { right: 50px; display: none; }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div id="loginContainer">
    <h2>Welcome to Caption Magic!</h2>
    <p>Login to start generating captivating captions for your photos.</p>
    <form class="login-form" onsubmit="return login(event)">
      <input type="text" id="username" placeholder="Username" required>
      <input type="password" id="password" placeholder="Password" required>
      <label><input type="checkbox" id="rememberMe"> Remember Me</label>
      <button type="submit">Login</button>
    </form>
  </div>

  <!-- Main App -->
  <div id="appContainer" class="hidden">
    <button onclick="logout()" style="float: right; margin: 10px;">Logout</button>
    <header>
      <h1>AI Photo Caption Generator</h1>
      <p>Transform your photos with engaging captions powered by Gemini AI!</p>
      <p id="welcomeMsg"></p>
    </header>

    <div class="toolbar">
      <input type="file" id="imageUpload" accept="image/*">
      <select id="styleSelect">
        <option value="default">Default</option>
        <option value="formal">Formal</option>
        <option value="fun">Fun</option>
      </select>
      <select id="fontSelect">
        <option value="Arial">Arial</option>
        <option value="Helvetica">Helvetica</option>
        <option value="Times New Roman">Times New Roman</option>
        <option value="Courier New">Courier New</option>
        <option value="Verdana">Verdana</option>
        <option value="Georgia">Georgia</option>
        <option value="Palatino">Palatino</option>
        <option value="Garamond">Garamond</option>
        <option value="Bookman">Bookman</option>
        <option value="Comic Sans MS">Comic Sans MS</option>
        <option value="Trebuchet MS">Trebuchet MS</option>
        <option value="Arial Black">Arial Black</option>
        <option value="Impact">Impact</option>
        <option value="Century Gothic">Century Gothic</option>
        <option value="Lucida Sans">Lucida Sans</option>
        <option value="Lucida Console">Lucida Console</option>
        <option value="Tahoma">Tahoma</option>
        <option value="Geneva">Geneva</option>
        <option value="Gill Sans">Gill Sans</option>
        <option value="Optima">Optima</option>
        <option value="Futura">Futura</option>
        <option value="Baskerville">Baskerville</option>
        <option value="Didot">Didot</option>
        <option value="Cambria">Cambria</option>
        <option value="Calibri">Calibri</option>
        <option value="Candara">Candara</option>
        <option value="Consolas">Consolas</option>
        <option value="Corbel">Corbel</option>
        <option value="Franklin Gothic">Franklin Gothic</option>
        <option value="Rockwell">Rockwell</option>
        <option value="Segoe UI">Segoe UI</option>
        <option value="Lato">Lato</option>
        <option value="Open Sans">Open Sans</option>
        <option value="Roboto">Roboto</option>
        <option value="Oswald">Oswald</option>
        <option value="Montserrat">Montserrat</option>
        <option value="Raleway">Raleway</option>
        <option value="Playfair Display">Playfair Display</option>
        <option value="Merriweather">Merriweather</option>
        <option value="Lora">Lora</option>
        <option value="PT Serif">PT Serif</option>
        <option value="Source Sans Pro">Source Sans Pro</option>
        <option value="Ubuntu">Ubuntu</option>
        <option value="Droid Sans">Droid Sans</option>
        <option value="Nunito">Nunito</option>
        <option value="Inconsolata">Inconsolata</option>
        <option value="Amatic SC">Amatic SC</option>
        <option value="Pacifico">Pacifico</option>
        <option value="Quicksand">Quicksand</option>
        <option value="Bebas Neue">Bebas Neue</option>
      </select>
      <input type="color" id="colorPicker" value="#ffffff">
      <button onclick="generateCaption()">Generate Caption</button>
      <button onclick="downloadImage()">Download Image</button>
      <button onclick="rotateImage()">Rotate Image</button>
      <button onclick="cropImage()">Crop Image</button>
    </div>

    <div class="preview-container">
      <canvas id="imageCanvas"></canvas>
      <div id="captionOverlay" contenteditable="false"></div>
      <button id="editIcon" onclick="editCaption()">‚úèÔ∏è</button>
      <button id="saveButton" onclick="saveCaption()">üíæ</button>
    </div>

    <div class="history-section">
      <h3>Photo History</h3>
      <div class="photo-grid" id="photoGrid"></div>
      <button class="clear-history" onclick="clearHistory()">Clear History</button>
    </div>
  </div>

  <script>
    const STYLES = {
      formal: { font: 'Playfair Display', color: '#ffffff', position: 'bottom-center', bg: '#00000080' },
      fun: { font: 'Comic Neue', color: '#FFD700', position: 'top-left', bg: '#FF69B480' },
      default: { font: 'Montserrat', color: '#ffffff', position: 'center', bg: '#00000080' }
    };

    let currentUser = null;
    // Login System
    function login(e) {
      e.preventDefault();
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const rememberMe = document.getElementById('rememberMe').checked;
      if (username && password) {
        currentUser = username;
        if (rememberMe) localStorage.setItem('savedUser', username);
        sessionStorage.setItem('loggedIn', 'true');
        showApp();
      }
      return false;
    }

    function logout() {
      currentUser = null;
      sessionStorage.removeItem('loggedIn');
      localStorage.removeItem('savedUser');
      window.location.reload();
    }

    function showApp() {
      document.getElementById('loginContainer').classList.add('hidden');
      document.getElementById('appContainer').classList.remove('hidden');
      document.getElementById('welcomeMsg').textContent = `Welcome, ${currentUser}! Let your creativity shine.`;
      loadHistory();
    }

    // Image Handling
    document.getElementById('imageUpload').addEventListener('change', function(e) {
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = function(event) {
        const img = new Image();
        img.src = event.target.result;
        img.onload = () => {
          const canvas = document.getElementById('imageCanvas');
          canvas.width = img.width;
          canvas.height = img.height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0);
        };
      };
      reader.readAsDataURL(file);
    });

    // Caption Generation using Gemini API
    async function generateCaption() {
      const canvas = document.getElementById('imageCanvas');
      if (!canvas.width || !canvas.height) {
        alert("Please upload an image first.");
        return;
      }
      const imageData = canvas.toDataURL('image/jpeg', 0.8);
      const style = document.getElementById('styleSelect').value;
      const apiKey = "AIzaSyBExqECRKhZKt5oec5TOVqrlLG9iDOx6Tk";
      try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{
              parts: [{
                text: `Generate a concise, engaging caption (up to 100 characters) in a ${style} style for the uploaded image using Gemini AI.`
              }]
            }]
          })
        });
        const data = await response.json();
        const caption = data.candidates[0].content.parts[0].text;
        applyCaption(caption, style);
        saveToHistory(imageData, caption, style);
      } catch (error) {
        alert('Error generating caption: ' + error.message);
      }
    }

    function applyCaption(caption, style) {
      const styleConfig = STYLES[style];
      const overlay = document.getElementById('captionOverlay');
      overlay.textContent = caption;
      overlay.setAttribute('title', caption);
      overlay.style.fontFamily = styleConfig.font;
      overlay.style.color = document.getElementById('colorPicker').value;
      
      // Position based on style configuration
      switch(styleConfig.position) {
        case 'bottom-center':
          overlay.style.bottom = '10px';
          overlay.style.top = 'auto';
          overlay.style.left = '50%';
          overlay.style.transform = 'translateX(-50%)';
          break;
        case 'top-left':
          overlay.style.top = '10px';
          overlay.style.left = '10px';
          overlay.style.transform = 'none';
          break;
        default: // center
          overlay.style.top = '50%';
          overlay.style.left = '50%';
          overlay.style.transform = 'translate(-50%, -50%)';
      }
    }

    // Photo History with localStorage quota management
    function saveToHistory(imageData, caption, style) {
      let history = JSON.parse(localStorage.getItem(currentUser) || '[]');
      history.unshift({ imageData, caption, style, date: new Date().toISOString() });
      try {
        localStorage.setItem(currentUser, JSON.stringify(history));
      } catch (e) {
        if (e.name === 'QuotaExceededError') {
          while (history.length > 0) {
            history.pop();
            try {
              localStorage.setItem(currentUser, JSON.stringify(history));
              break;
            } catch (error) {
              continue;
            }
          }
        }
      }
      loadHistory();
    }

    function loadHistory() {
      const history = JSON.parse(localStorage.getItem(currentUser) || '[]');
      const grid = document.getElementById('photoGrid');
      grid.innerHTML = history.map((item, index) => `
        <div class="photo-item">
          <img src="${item.imageData}">
          <p>${item.caption}</p>
          <button class="delete-btn" onclick="deletePhoto(${index})">√ó</button>
        </div>
      `).join('');
    }

    function deletePhoto(index) {
      const history = JSON.parse(localStorage.getItem(currentUser));
      history.splice(index, 1);
      localStorage.setItem(currentUser, JSON.stringify(history));
      loadHistory();
    }

    function clearHistory() {
      if(confirm("Are you sure you want to clear your photo history?")) {
        localStorage.removeItem(currentUser);
        loadHistory();
      }
    }

    // Edit Caption ‚Äì make the overlay immediately editable and reveal the Save button
    function editCaption() {
      const overlay = document.getElementById('captionOverlay');
      overlay.contentEditable = true;
      overlay.classList.add('editing');
      document.getElementById('saveButton').style.display = 'block';
      overlay.focus();
    }

    // Save Caption ‚Äì exit editing mode and update history with the new caption text
    function saveCaption() {
      const overlay = document.getElementById('captionOverlay');
      overlay.contentEditable = false;
      overlay.classList.remove('editing');
      document.getElementById('saveButton').style.display = 'none';
      const canvas = document.getElementById('imageCanvas');
      const imageData = canvas.toDataURL('image/jpeg', 0.8);
      const style = document.getElementById('styleSelect').value;
      saveToHistory(imageData, overlay.textContent, style);
    }

    // Download Image with overlay caption
    function downloadImage() {
      const canvas = document.getElementById('imageCanvas');
      const ctx = canvas.getContext('2d');
      const overlay = document.getElementById('captionOverlay');
      const img = new Image();
      img.src = canvas.toDataURL();
      img.onload = () => {
        ctx.drawImage(img, 0, 0);
        const computedStyle = window.getComputedStyle(overlay);
        const fontSize = computedStyle.fontSize || "24px";
        const fontFamily = computedStyle.fontFamily;
        ctx.font = `${fontSize} ${fontFamily}`;
        ctx.fillStyle = computedStyle.color;
        const x = parseInt(overlay.style.left) || 20;
        const y = parseInt(overlay.style.top) || 20;
        ctx.fillText(overlay.textContent, x, y);
        const link = document.createElement('a');
        link.href = canvas.toDataURL();
        link.download = 'captioned_image.png';
        link.click();
      };
    }

    // Rotate Image 90¬∞ Clockwise
    function rotateImage() {
      const canvas = document.getElementById('imageCanvas');
      const ctx = canvas.getContext('2d');
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const newCanvas = document.createElement('canvas');
      newCanvas.width = canvas.height;
      newCanvas.height = canvas.width;
      const newCtx = newCanvas.getContext('2d');
      newCtx.translate(newCanvas.width / 2, newCanvas.height / 2);
      newCtx.rotate(Math.PI / 2);
      newCtx.drawImage(canvas, -canvas.width / 2, -canvas.height / 2);
      canvas.width = newCanvas.width;
      canvas.height = newCanvas.height;
      ctx.drawImage(newCanvas, 0, 0);
    }

    // Crop Image to overlay area
    function cropImage() {
      const canvas = document.getElementById('imageCanvas');
      const ctx = canvas.getContext('2d');
      const overlay = document.getElementById('captionOverlay');
      const x = overlay.offsetLeft;
      const y = overlay.offsetTop;
      const width = overlay.offsetWidth;
      const height = overlay.offsetHeight;
      const croppedData = ctx.getImageData(x, y, width, height);
      canvas.width = width;
      canvas.height = height;
      ctx.putImageData(croppedData, 0, 0);
    }

    // Enable dragging of the caption overlay
    const overlay = document.getElementById('captionOverlay');
    overlay.addEventListener('mousedown', (e) => {
      const shiftX = e.clientX - overlay.getBoundingClientRect().left;
      const shiftY = e.clientY - overlay.getBoundingClientRect().top;
      function moveAt(clientX, clientY) {
        overlay.style.left = clientX - shiftX + 'px';
        overlay.style.top = clientY - shiftY + 'px';
      }
      function onMouseMove(event) {
        moveAt(event.clientX, event.clientY);
      }
      document.addEventListener('mousemove', onMouseMove);
      document.onmouseup = () => {
        document.removeEventListener('mousemove', onMouseMove);
        document.onmouseup = null;
      };
    });

    // Initial Check for login status
    window.onload = () => {
      const savedUser = localStorage.getItem('savedUser');
      if (sessionStorage.getItem('loggedIn') || savedUser) {
        currentUser = savedUser;
        showApp();
      }
    };
  </script>
</body>
</html>
