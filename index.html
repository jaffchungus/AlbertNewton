<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Caption AI</title>
    <style>
        body {
            font-family: 'Helvetica Neue', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f2f5;
            color: #333;
        }
        .container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        header {
            background-color: #4267B2;
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        header nav button {
            margin: 0 10px;
            padding: 10px 20px;
            background: #365899;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        header nav button:hover {
            background: #2e4a87;
        }
        .sidebar {
            width: 250px;
            background: #365899;
            color: white;
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
        }
        .sidebar button {
            width: 100%;
            padding: 15px;
            background: #4267B2;
            color: white;
            border: none;
            border-radius: 5px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .sidebar button:hover {
            background: #3b5998;
        }
        main {
            flex: 1;
            padding: 20px;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin: 20px;
        }
        .photo-upload {
            margin-top: 20px;
        }
        .photo-upload input {
            display: none;
        }
        .photo-upload label {
            padding: 10px 20px;
            background: #0078d4;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .photo-upload label:hover {
            background: #005a9e;
        }
        .photo-display {
            margin-top: 20px;
            position: relative;
        }
        .photo-display img {
            max-width: 100%;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .photo-display .caption {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 18px;
        }
        .settings {
            margin-top: 20px;
        }
        .settings label {
            margin-right: 10px;
        }
        .photo-history {
            margin-top: 20px;
        }
        .photo-history img {
            max-width: 100%;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .photo-history button {
            margin-top: 10px;
        }
        .login-form, .register-form {
            display: none;
            flex-direction: column;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .login-form input, .register-form input {
            margin-bottom: 15px;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Photo Caption AI</h1>
            <nav>
                <button id="loginBtn" onclick="showLoginForm()">Login</button>
                <button id="registerBtn" onclick="showRegisterForm()">Register</button>
                <button id="logoutBtn" onclick="logout()" style="display:none;">Logout</button>
            </nav>
        </header>
        <aside class="sidebar">
            <button onclick="showTab('upload')">Upload Photo</button>
            <button onclick="showTab('history')">Photo History</button>
        </aside>
        <main>
            <div id="uploadTab" class="tab-content active">
                <section class="photo-upload">
                    <h2>Upload Photo</h2>
                    <input type="file" id="photoUpload" accept="image/*">
                    <label for="photoUpload">Choose Photo</label>
                    <div class="settings">
                        <label>
                            <input type="radio" name="fontStyle" value="Formal" checked> Formal
                        </label>
                        <label>
                            <input type="radio" name="fontStyle" value="Fun"> Fun
                        </label>
                        <label>
                            <input type="radio" name="fontStyle" value="Default"> Default
                        </label>
                    </div>
                    <div class="photo-display">
                        <img id="uploadedPhoto" src="" alt="Uploaded Photo">
                        <div class="caption" id="photoCaption"></div>
                    </div>
                </section>
            </div>
            <div id="historyTab" class="tab-content">
                <section class="photo-history">
                    <h2>Photo History</h2>
                    <div id="photoHistory"></div>
                </section>
            </div>
            <div class="login-form" id="loginForm">
                <h2>Login</h2>
                <input type="text" id="loginUsername" placeholder="Username">
                <input type="password" id="loginPassword" placeholder="Password">
                <label><input type="checkbox" id="rememberMe"> Remember me</label>
                <button onclick="login()">Login</button>
            </div>
            <div class="register-form" id="registerForm">
                <h2>Register</h2>
                <input type="text" id="registerUsername" placeholder="Username">
                <input type="password" id="registerPassword" placeholder="Password">
                <button onclick="register()">Register</button>
            </div>
        </main>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let users = [];
            let currentUser = null;
            let photoHistory = [];

            async function getGeminiResponse(prompt) {
                const geminiApiKey = "AIzaSyBExqECRKhZKt5oec5TOVqrlLG9iDOx6Tk";
                if (!geminiApiKey) {
                    return 'Please add your Gemini API key in the Secrets tool';
                }
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${geminiApiKey}`;
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{
                                    text: prompt
                                }]
                            }]
                        })
                    });
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    if (data.candidates && data.candidates[0]?.content?.parts?.[0]?.text) {
                        return data.candidates[0].content.parts[0].text;
                    } else {
                        throw new Error('Invalid response format');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    return `Error: ${error.message}`;
                }
            }

            function saveData() {
                localStorage.setItem('users', JSON.stringify(users));
                if (currentUser && document.getElementById('rememberMe').checked) {
                    localStorage.setItem('currentUser', currentUser.username);
                }
                localStorage.setItem('photoHistory', JSON.stringify(photoHistory));
            }

            function loadData() {
                users = JSON.parse(localStorage.getItem('users')) || [];
                const storedUser = localStorage.getItem('currentUser');
                if (storedUser) {
                    currentUser = users.find(user => user.username === storedUser);
                    if (currentUser) {
                        document.getElementById('loginBtn').style.display = 'none';
                        document.getElementById('registerBtn').style.display = 'none';
                        document.getElementById('logoutBtn').style.display = 'inline';
                    }
                }
                photoHistory = JSON.parse(localStorage.getItem('photoHistory')) || [];
                displayPhotoHistory();
            }

            function displayPhotoHistory() {
                const photoHistoryElem = document.getElementById('photoHistory');
                photoHistoryElem.innerHTML = '';
                photoHistory.forEach((photo, index) => {
                    const photoElement = document.createElement('div');
                    photoElement.innerHTML = `<img src="${photo.url}" alt="History Photo">
                                              <button onclick="deletePhoto(${index})">Delete</button>`;
                    photoHistoryElem.appendChild(photoElement);
                });
            }

            window.deletePhoto = function(index) {
                if (confirm('Are you sure you want to delete this photo?')) {
                    photoHistory.splice(index, 1);
                    saveData();
                    displayPhotoHistory();
                }
            }

            window.showLoginForm = function() {
                document.getElementById('loginForm').style.display = 'flex';
                document.getElementById('registerForm').style.display = 'none';
            }

            window.showRegisterForm = function() {
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('registerForm').style.display = 'flex';
            }

            window.login = function() {
                const username = document.getElementById('loginUsername').value;
                const password = document.getElementById('loginPassword').value;
                currentUser = users.find(user => user.username === username && user.password === password);
                if (currentUser) {
                    alert("Logged in!");
                    document.getElementById('loginBtn').style.display = 'none';
                    document.getElementById('registerBtn').style.display = 'none';
                    document.getElementById('logoutBtn').style.display = 'inline';
                    document.getElementById('loginForm').style.display = 'none';
                    saveData();
                } else {
                    alert("Invalid username or password.");
                }
            }

            window.register = function() {
                const username = document.getElementById('registerUsername').value;
                const password = document.getElementById('registerPassword').value;
                if (username && password) {
                    users.push({
                        username,
                        password
                    });
                    saveData();
                    alert("Registration successful!");
                    document.getElementById('registerForm').style.display = 'none';
                } else {
                    alert("Please fill in all fields.");
                }
            }

            window.logout = function() {
                currentUser = null;
                localStorage.removeItem('currentUser');
                document.getElementById('loginBtn').style.display = 'inline';
                document.getElementById('registerBtn').style.display = 'inline';
                document.getElementById('logoutBtn').style.display = 'none';
                alert("Logged out!");
            }

            window.showTab = function(tabId) {
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.getElementById(tabId + 'Tab').classList.add('active');
            }

            document.getElementById('photoUpload').addEventListener('change', async function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = async function(e) {
                        const imageUrl = e.target.result;
                        document.getElementById('uploadedPhoto').src = imageUrl;

                        // Generate caption
                        const caption = await getGeminiResponse(`Generate a caption for this photo: ${imageUrl}`);
                        document.getElementById('photoCaption').textContent = caption;

                        // Save photo to history
                        photoHistory.push({ url: imageUrl, caption: caption });
                        saveData();
                        displayPhotoHistory();

                        // Apply styling based on settings
                        const fontStyle = document.querySelector('input[name="fontStyle"]:checked').value;
                        applyCaptionStyle(fontStyle);
                    };
                    reader.readAsDataURL(file);
                }
            });

            function applyCaptionStyle(fontStyle) {
                const captionElem = document.getElementById('photoCaption');
                switch (fontStyle) {
                    case 'Formal':
                        captionElem.style.fontFamily = 'serif';
                        captionElem.style.color = 'white';
                        break;
                    case 'Fun':
                        captionElem.style.fontFamily = 'cursive';
                        captionElem.style.color = 'yellow';
                        break;
                    case 'Default':
                        captionElem.style.fontFamily = 'sans-serif';
                        captionElem.style.color = 'white';
                        break;
                }
            }

            loadData();
        });
    </script>
</body>
</html>
